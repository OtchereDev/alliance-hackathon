import { json, LoaderFunctionArgs } from '@remix-run/node'
import { Form, useLoaderData } from '@remix-run/react'
import { Search } from 'lucide-react'
import CampaignsChart from '~/components/dashboard/CampaignChart'
import DonationTypesChart from '~/components/dashboard/DonationTypesChart'
import RefundChart from '~/components/dashboard/RefundChart'
import DateFilter from '~/components/shared/DateFilter'
import { DonationTable } from '~/components/tables/DonationTable'
import { formatMoney } from '~/lib/formatMoney'
import {
  getTotalDonationsAmount,
  getTotalRefundsAmount,
} from '~/server/campaign'
import { db } from '~/server/db.server'

export async function loader({ request }: LoaderFunctionArgs) {
  const donationType = [
    {
      name: 'Individual Donations',
      value: await db.campaignDonations.count({
        where: { isCompanyDonation: false },
      }),
    },
    {
      name: 'Company Donations',
      value: await db.campaignDonations.count({
        where: { isCompanyDonation: true },
      }),
    },
  ]

  const published = await db.campaign.count({
    where: { status: 'PUBLISHED' },
  })
  const totalDonations = await getTotalDonationsAmount()
  const totalRefund = await getTotalRefundsAmount()

  const campaigns = [
    {
      name: 'Published campaigns',
      value: published,
    },
    {
      name: 'Ended campaigns',
      value: await db.campaign.count({
        where: { status: 'ENDED' },
      }),
    },
    {
      name: 'Draft campaigns',
      value: await db.campaign.count({
        where: { status: 'DRAFT' },
      }),
    },
  ]

  const refund = [
    {
      name: 'Complete refunds',
      value: await db.donationRefund.count({
        where: { fulfilled: true },
      }),
    },
    {
      name: 'Incomplete refunds',
      value: await db.donationRefund.count({
        where: { fulfilled: false },
      }),
    },
  ]

  const donations = await db.campaignDonations.findMany()

  return json({
    donationType,
    campaigns,
    refund,
    donations,
    totalPublished: published,
    totalDonations,
    totalRefund,
  })
}

export default function DashboardIndex() {
  const {
    campaigns,
    refund,
    donationType,
    donations,
    totalDonations,
    totalPublished,
    totalRefund,
  } = useLoaderData<typeof loader>()
  return (
    <div className="mt-10">
      <DateFilter />

      <div className="mt-8 flex gap-[25px]">
        <div className="box-sh w-[340px] rounded-[16px] p-5">
          <div className="flex justify-between">
            <h3>Total Donations</h3>

            <div className="flex size-[45px] items-center justify-center rounded-full bg-[#DBF4E9]">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M15.75 5.75V8.325C16.5969 8.49812 17.358 8.95843 17.9046 9.62807C18.4512 10.2977 18.7498 11.1356 18.7498 12C18.7498 12.8644 18.4512 13.7023 17.9046 14.3719C17.358 15.0416 16.5969 15.5019 15.75 15.675V18.249C16.787 18.247 17.574 18.234 18.21 18.169C18.98 18.091 19.445 17.943 19.806 17.702C20.16 17.465 20.466 17.16 20.702 16.806C20.943 16.445 21.092 15.979 21.17 15.21C21.25 14.429 21.25 13.42 21.25 12C21.25 10.58 21.25 9.571 21.17 8.79C21.091 8.02 20.943 7.555 20.702 7.194C20.464 6.84026 20.1597 6.53598 19.806 6.298C19.445 6.057 18.979 5.908 18.21 5.83C17.574 5.766 16.787 5.753 15.75 5.75ZM14.25 18.25V5.75H9.75V18.25H14.25ZM8.25 18.25V15.675C7.40311 15.5019 6.642 15.0416 6.0954 14.3719C5.5488 13.7023 5.25025 12.8644 5.25025 12C5.25025 11.1356 5.5488 10.2977 6.0954 9.62807C6.642 8.95843 7.40311 8.49812 8.25 8.325V5.751C7.213 5.753 6.426 5.766 5.79 5.831C5.02 5.909 4.555 6.057 4.194 6.298C3.84026 6.53598 3.53598 6.84026 3.298 7.194C3.057 7.555 2.908 8.021 2.83 8.79C2.75 9.571 2.75 10.58 2.75 12C2.75 13.42 2.75 14.429 2.83 15.21C2.909 15.98 3.057 16.445 3.298 16.806C3.535 17.16 3.84 17.466 4.194 17.702C4.555 17.943 5.021 18.092 5.79 18.17C6.426 18.234 7.213 18.247 8.25 18.25ZM8.25 9.878C7.81085 10.0328 7.43055 10.3201 7.16155 10.7001C6.89254 11.0802 6.74808 11.5344 6.74808 12C6.74808 12.4656 6.89254 12.9198 7.16155 13.2999C7.43055 13.6799 7.81085 13.9672 8.25 14.122V9.878ZM15.75 14.122C16.1887 13.9667 16.5685 13.6793 16.8371 13.2993C17.1057 12.9193 17.2499 12.4654 17.2499 12C17.2499 11.5346 17.1057 11.0807 16.8371 10.7007C16.5685 10.3207 16.1887 10.0333 15.75 9.878V14.122ZM18.362 4.338C19.25 4.428 19.991 4.618 20.639 5.051C21.158 5.397 21.603 5.842 21.949 6.361C22.383 7.009 22.572 7.751 22.662 8.638C22.75 9.504 22.75 10.589 22.75 11.958V12.042C22.75 13.411 22.75 14.496 22.662 15.362C22.572 16.25 22.382 16.991 21.95 17.639C21.6023 18.1567 21.157 18.6016 20.639 18.949C19.991 19.383 19.249 19.572 18.362 19.662C17.496 19.75 16.411 19.75 15.042 19.75H8.958C7.589 19.75 6.504 19.75 5.638 19.662C4.75 19.572 4.009 19.382 3.361 18.95C2.84331 18.6023 2.39835 18.157 2.051 17.639C1.617 16.991 1.428 16.249 1.338 15.362C1.25 14.496 1.25 13.411 1.25 12.042V11.958C1.25 10.589 1.25 9.504 1.338 8.638C1.428 7.75 1.618 7.009 2.051 6.361C2.39846 5.84341 2.84341 5.39846 3.361 5.051C4.009 4.617 4.751 4.428 5.638 4.338C6.504 4.25 7.589 4.25 8.958 4.25H15.042C16.411 4.25 17.496 4.25 18.362 4.338Z"
                  fill="#006B4B"
                />
              </svg>
            </div>
          </div>
          <p className="mt-3 text-2xl font-bold">
            {formatMoney(totalDonations)}
          </p>
        </div>
        <div className="box-sh w-[340px] rounded-[16px] p-5">
          <div className="flex justify-between">
            <h3>Total Published Campaigns</h3>

            <div className="flex size-[45px] items-center justify-center rounded-full bg-[#0085FF26]">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M14 11C14 10.7348 14.1054 10.4804 14.2929 10.2929C14.4804 10.1054 14.7348 10 15 10C15.2652 10 15.5196 10.1054 15.7071 10.2929C15.8946 10.4804 16 10.7348 16 11V13C16 13.2652 15.8946 13.5196 15.7071 13.7071C15.5196 13.8946 15.2652 14 15 14C14.7348 14 14.4804 13.8946 14.2929 13.7071C14.1054 13.5196 14 13.2652 14 13V11Z"
                  stroke="#0085FF"
                  stroke-width="1.5"
                />
                <path
                  d="M14.0141 17L14.7641 17.002V17H14.0141ZM14.0141 7H14.7641V6.998L14.0141 7ZM14.7581 19.005L14.7641 17.002L13.2641 16.998L13.2581 19.001L14.7581 19.005ZM15.0161 16.75C15.1571 16.75 15.2691 16.864 15.2691 17H16.7691C16.7691 16.032 15.9821 15.25 15.0161 15.25V16.75ZM15.0161 15.25C14.0501 15.25 13.2641 16.032 13.2641 17H14.7641C14.7641 16.864 14.8751 16.75 15.0161 16.75V15.25ZM9.99513 4.75H13.5051V3.25H9.99513V4.75ZM13.0081 19.25H9.99513V20.75H13.0081V19.25ZM9.99513 19.25C8.08413 19.25 6.72513 19.248 5.69513 19.11C4.68513 18.975 4.10413 18.721 3.67913 18.297L2.62013 19.36C3.37013 20.108 4.32213 20.44 5.49613 20.598C6.65013 20.753 8.12613 20.751 9.99613 20.751L9.99513 19.25ZM9.99513 3.25C8.12513 3.25 6.64913 3.248 5.49513 3.403C4.32113 3.561 3.37013 3.893 2.62013 4.641L3.68013 5.703C4.10413 5.279 4.68613 5.025 5.69513 4.89C6.72513 4.752 8.08413 4.75 9.99513 4.75V3.25ZM2.58713 10.909C2.97313 11.124 3.23013 11.533 3.23013 12H4.73013C4.73006 11.5105 4.59933 11.0299 4.35147 10.6079C4.1036 10.1858 3.74757 9.83751 3.32013 9.599L2.58713 10.909ZM2.76013 9.02C2.83813 7.164 3.09113 6.289 3.68013 5.703L2.62013 4.641C1.59013 5.669 1.34013 7.08 1.26013 8.958L2.76013 9.02ZM3.23013 12C3.23013 12.467 2.97313 12.876 2.58713 13.092L3.31913 14.402C3.7469 14.1635 4.10323 13.8152 4.35129 13.3929C4.59935 12.9706 4.73013 12.4897 4.73013 12H3.23013ZM1.26113 15.042C1.34113 16.918 1.59113 18.332 2.62013 19.359L3.68013 18.297C3.09113 17.711 2.83813 16.835 2.76013 14.979L1.26113 15.042ZM20.7701 12C20.7701 11.533 21.0271 11.124 21.4131 10.909L20.6811 9.599C20.2535 9.83738 19.8973 10.1856 19.6492 10.6077C19.4012 11.0298 19.2703 11.5104 19.2701 12H20.7701ZM22.7391 8.958C22.6591 7.082 22.4091 5.668 21.3801 4.641L20.3201 5.703C20.9081 6.289 21.1621 7.165 21.2401 9.021L22.7391 8.958ZM21.4131 13.092C21.2184 12.9838 21.056 12.8255 20.943 12.6335C20.8299 12.4415 20.7703 12.2228 20.7701 12H19.2701C19.2701 13.034 19.8411 13.932 20.6811 14.401L21.4131 13.092ZM21.2401 14.979C21.1621 16.835 20.9091 17.711 20.3201 18.297L21.3801 19.359C22.4101 18.332 22.6601 16.919 22.7391 15.042L21.2401 14.979ZM20.6811 14.401C20.9651 14.56 21.1511 14.664 21.2761 14.743C21.3381 14.782 21.3661 14.803 21.3741 14.809C21.3881 14.821 21.3371 14.785 21.2891 14.699L22.5991 13.966C22.5299 13.846 22.4386 13.7401 22.3301 13.654C22.2495 13.5886 22.1646 13.5284 22.0761 13.474C21.9091 13.368 21.6801 13.241 21.4131 13.091L20.6811 14.401ZM22.7391 15.042C22.7461 14.871 22.7541 14.694 22.7481 14.546C22.744 14.3436 22.6926 14.145 22.5981 13.966L21.2891 14.698C21.2391 14.608 21.2461 14.546 21.2491 14.612C21.2505 14.6387 21.2505 14.6833 21.2491 14.746L21.2401 14.979L22.7391 15.042ZM21.4131 10.909C21.6801 10.759 21.9091 10.632 22.0761 10.526C22.1639 10.4704 22.2486 10.4104 22.3301 10.346C22.4383 10.2598 22.5292 10.1539 22.5981 10.034L21.2891 9.302C21.3371 9.215 21.3881 9.179 21.3731 9.191C21.3421 9.21488 21.3097 9.23692 21.2761 9.257C21.1511 9.337 20.9661 9.44 20.6811 9.599L21.4131 10.909ZM21.2401 9.021L21.2491 9.253C21.2505 9.31567 21.2505 9.36033 21.2491 9.387C21.2461 9.453 21.2391 9.391 21.2891 9.301L22.5991 10.033C22.6933 9.8539 22.7443 9.6553 22.7481 9.453C22.7516 9.2876 22.7483 9.12213 22.7381 8.957L21.2401 9.021ZM2.58713 13.091C2.32013 13.241 2.09113 13.367 1.92413 13.473C1.83566 13.5274 1.75081 13.5876 1.67013 13.653C1.56198 13.7392 1.47106 13.8461 1.40213 13.966L2.71113 14.697C2.66313 14.784 2.61213 14.82 2.62613 14.808C2.63513 14.801 2.66213 14.781 2.72413 14.742C2.84913 14.662 3.03413 14.559 3.31913 14.4L2.58713 13.091ZM2.76013 14.978L2.75113 14.745C2.74964 14.7003 2.74964 14.6557 2.75113 14.611C2.75413 14.545 2.76113 14.607 2.71113 14.697L1.40113 13.965C1.30701 14.1441 1.25599 14.3427 1.25213 14.545C1.24613 14.693 1.25413 14.87 1.26213 15.041L2.76013 14.978ZM3.31913 9.598C3.03513 9.439 2.84913 9.335 2.72413 9.256C2.69019 9.23595 2.65747 9.21391 2.62613 9.19C2.61213 9.178 2.66313 9.214 2.71113 9.3L1.40113 10.033C1.48513 10.181 1.59613 10.283 1.67013 10.345C1.75013 10.411 1.83913 10.471 1.92413 10.525C2.09113 10.631 2.32013 10.758 2.58713 10.908L3.31913 9.598ZM1.26013 8.958C1.25313 9.129 1.24513 9.306 1.25113 9.454C1.25813 9.604 1.28113 9.821 1.40113 10.034L2.71113 9.302C2.76113 9.392 2.75313 9.454 2.75013 9.388C2.74864 9.34335 2.74864 9.29866 2.75013 9.254L2.75913 9.021L1.26013 8.958ZM14.7631 6.998L14.7551 4.496L13.2561 4.501L13.2631 7.002L14.7631 6.998ZM15.0151 7.25C14.9821 7.25027 14.9494 7.24399 14.9188 7.23155C14.8883 7.2191 14.8605 7.20073 14.8371 7.17749C14.8136 7.15425 14.795 7.1266 14.7824 7.09614C14.7697 7.06567 14.7631 7.033 14.7631 7H13.2631C13.2631 7.968 14.0491 8.75 15.0151 8.75V7.25ZM15.2701 7C15.2701 7.136 15.1581 7.25 15.0171 7.25V8.75C15.9831 8.75 16.7701 7.968 16.7701 7H15.2701ZM15.2701 4.516V7H16.7701V4.516H15.2701ZM16.5101 4.769C18.6981 4.825 19.6791 5.061 20.3221 5.703L21.3821 4.641C20.2691 3.531 18.6951 3.325 16.5481 3.269L16.5101 4.769ZM16.7701 4.516C16.7701 4.656 16.6541 4.772 16.5101 4.769L16.5481 3.269C16.3818 3.26486 16.2163 3.29406 16.0614 3.35488C15.9065 3.41569 15.7654 3.50689 15.6463 3.6231C15.5272 3.7393 15.4325 3.87817 15.3679 4.03152C15.3033 4.18487 15.2701 4.3496 15.2701 4.516H16.7701ZM13.5051 4.75C13.439 4.74974 13.3767 4.72328 13.33 4.67643C13.2833 4.62957 13.2571 4.56613 13.2571 4.5L14.7571 4.496C14.7561 4.16517 14.6239 3.84826 14.3896 3.6147C14.1553 3.38115 13.838 3.25 13.5071 3.25L13.5051 4.75ZM17.0651 20.714C18.9401 20.634 20.3541 20.384 21.3811 19.359L20.3201 18.297C19.7341 18.883 18.8571 19.137 17.0031 19.215L17.0651 20.714ZM15.2701 17V18.977H16.7701V17H15.2701ZM13.2591 19C13.2591 19.121 13.2591 19.214 13.2561 19.293C13.2541 19.373 13.2501 19.419 13.2461 19.448C13.2421 19.477 13.2411 19.467 13.2521 19.438C13.2715 19.3953 13.2983 19.3564 13.3311 19.323L14.3901 20.385C14.5829 20.1858 14.7033 19.9277 14.7321 19.652C14.7591 19.455 14.7571 19.219 14.7581 19.005L13.2591 19ZM13.0081 20.75C13.2221 20.75 13.4591 20.752 13.6561 20.725C13.8751 20.695 14.1541 20.62 14.3901 20.385L13.3301 19.323C13.3642 19.2903 13.4038 19.2639 13.4471 19.245C13.4751 19.233 13.4851 19.235 13.4571 19.238C13.4053 19.2434 13.3532 19.2467 13.3011 19.248C13.2211 19.25 13.1281 19.25 13.0081 19.25V20.75ZM17.0031 19.215C16.8831 19.22 16.7901 19.224 16.7111 19.225C16.6321 19.226 16.5861 19.225 16.5591 19.222C16.5321 19.219 16.5441 19.217 16.5741 19.229C16.6111 19.243 16.6541 19.269 16.6931 19.305L15.6551 20.388C15.8991 20.622 16.1841 20.692 16.4121 20.714C16.6141 20.734 16.8511 20.723 17.0651 20.714L17.0031 19.215ZM15.2701 18.977C15.2701 19.195 15.2681 19.437 15.2961 19.64C15.3271 19.866 15.4081 20.151 15.6551 20.388L16.6931 19.305C16.7331 19.343 16.7591 19.386 16.7751 19.422C16.7871 19.452 16.7851 19.462 16.7821 19.434C16.7767 19.3812 16.7734 19.3281 16.7721 19.275C16.7701 19.195 16.7701 19.1 16.7701 18.977H15.2701Z"
                  fill="#0085FF"
                />
              </svg>
            </div>
          </div>
          <p className="mt-3 text-2xl font-bold">{totalPublished}</p>
        </div>
        <div className="box-sh w-[340px] rounded-[16px] p-5">
          <div className="flex justify-between">
            <h3>Total Refunds</h3>

            <div className="flex size-[45px] items-center justify-center rounded-full bg-[#F7900926]">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M17.414 10.414C18 9.828 18 8.886 18 7C18 5.114 18 4.172 17.414 3.586M17.414 10.414C16.828 11 15.886 11 14 11H10C8.114 11 7.172 11 6.586 10.414M17.414 3.586C16.828 3 15.886 3 14 3H10C8.114 3 7.172 3 6.586 3.586M6.586 3.586C6 4.172 6 5.114 6 7C6 8.886 6 9.828 6.586 10.414M13 7C13 7.26522 12.8946 7.51957 12.7071 7.70711C12.5196 7.89464 12.2652 8 12 8C11.7348 8 11.4804 7.89464 11.2929 7.70711C11.1054 7.51957 11 7.26522 11 7C11 6.73478 11.1054 6.48043 11.2929 6.29289C11.4804 6.10536 11.7348 6 12 6C12.2652 6 12.5196 6.10536 12.7071 6.29289C12.8946 6.48043 13 6.73478 13 7Z"
                  stroke="#F79009"
                  stroke-width="1.5"
                />
                <path
                  d="M18 6C17.2044 6 16.4413 5.68393 15.8787 5.12132C15.3161 4.55871 15 3.79565 15 3M18 8C17.2044 8 16.4413 8.31607 15.8787 8.87868C15.3161 9.44129 15 10.2044 15 11M6 6C6.79565 6 7.55871 5.68393 8.12132 5.12132C8.68393 4.55871 9 3.79565 9 3M6 8C6.79565 8 7.55871 8.31607 8.12132 8.87868C8.68393 9.44129 9 10.2044 9 11M5 20.388H7.26C8.27 20.388 9.293 20.494 10.276 20.696C12.0311 21.0554 13.8367 21.0954 15.606 20.814C16.474 20.674 17.326 20.459 18.098 20.087C18.794 19.75 19.647 19.277 20.22 18.746C20.792 18.216 21.388 17.349 21.81 16.671C22.174 16.089 21.998 15.376 21.424 14.943C21.1013 14.7088 20.7127 14.5827 20.314 14.5827C19.9153 14.5827 19.5267 14.7088 19.204 14.943L17.397 16.308C16.697 16.838 15.932 17.325 15.021 17.47C14.911 17.4873 14.796 17.503 14.676 17.517M14.676 17.517L14.566 17.529M14.676 17.517C14.836 17.4736 14.9828 17.3912 15.103 17.277C15.2539 17.1468 15.3772 16.9876 15.4655 16.8089C15.5538 16.6302 15.6054 16.4356 15.6171 16.2366C15.6289 16.0377 15.6006 15.8383 15.5339 15.6505C15.4672 15.4626 15.3636 15.2901 15.229 15.143C15.0987 14.9983 14.9469 14.8746 14.779 14.776C11.982 13.107 7.629 14.378 5 16.243M14.676 17.517C14.6399 17.5251 14.603 17.5291 14.566 17.529M14.566 17.529C13.9629 17.5894 13.3554 17.5908 12.752 17.533"
                  stroke="#F79009"
                  stroke-width="1.5"
                  stroke-linecap="round"
                />
                <path
                  d="M5 15.5C5 14.6716 4.32843 14 3.5 14C2.67157 14 2 14.6716 2 15.5V20.5C2 21.3284 2.67157 22 3.5 22C4.32843 22 5 21.3284 5 20.5V15.5Z"
                  stroke="#F79009"
                  stroke-width="1.5"
                />
              </svg>
            </div>
          </div>
          <p className="mt-3 text-2xl font-bold">{formatMoney(totalRefund)}</p>
        </div>
      </div>

      <div className="mt-8 flex gap-[25px]">
        <div className="box-sh w-[340px] rounded-[16px] p-5">
          <p className="font-bold">Donation Types</p>
          <DonationTypesChart data={donationType} />
        </div>
        <div className="box-sh w-[340px] rounded-[16px] p-5">
          <p className="font-bold">Campaigns</p>
          <CampaignsChart data={campaigns} />
        </div>
        <div className="box-sh w-[340px] rounded-[16px] p-5">
          <p className="font-bold">Refunds</p>
          <RefundChart data={refund} />
        </div>
      </div>

      <div className="mt-[35px] flex items-center justify-between lg:mt-[60px]">
        <Form name="search" method="GET" className="flex w-full gap-2">
          <div className="flex max-w-[215px] flex-1 items-center gap-3 rounded-full border border-ablack px-[14px] py-[10px] lg:max-w-[311px]">
            <Search strokeWidth={2.5} size={18} />
            <input
              type="text"
              name="search"
              placeholder="Search company"
              className="font-montserrat placeholder:font-montserrat flex-1 outline-none"
            />
          </div>
        </Form>
      </div>

      <div className="mt-[40px]">
        <DonationTable data={donations as any} />
      </div>
    </div>
  )
}
